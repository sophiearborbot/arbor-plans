<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arbor Family Plans ‚Äî Sophie's Hub</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f1117; color: #e8eaf0; min-height: 100vh; }

  header {
    background: linear-gradient(135deg, #1a1f2e, #2a1f3a);
    padding: 28px 32px 20px;
    border-bottom: 1px solid #2e3a50;
  }
  .header-top { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
  header h1 { font-size: 1.6rem; font-weight: 800; color: #e8eaf0; }
  header p { color: #7a8a9a; margin-top: 4px; font-size: 0.85rem; }
  .sophie-tag {
    background: rgba(156,39,176,0.15); border: 1px solid rgba(156,39,176,0.3);
    color: #ce93d8; padding: 5px 14px; border-radius: 20px; font-size: 0.75rem; white-space: nowrap;
  }

  /* FILTER BAR */
  .filter-bar {
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    padding: 14px 32px; background: #13151f; border-bottom: 1px solid #1e2433;
    position: sticky; top: 0; z-index: 100;
  }
  .filter-label { font-size: 0.72rem; color: #546e7a; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-right: 4px; }
  .filter-btn {
    padding: 5px 13px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
    border: 1px solid transparent; cursor: pointer; transition: all 0.15s;
    background: rgba(255,255,255,0.05); color: #7a8a9a; border-color: #2e3a50;
  }
  .filter-btn:hover { color: #e8eaf0; border-color: #4a5a6a; }
  .filter-btn.active { color: #fff; }
  .filter-btn[data-filter="all"].active { background: rgba(255,255,255,0.12); border-color: #546e7a; color: #e8eaf0; }
  .filter-btn[data-filter="sage"].active { background: rgba(76,175,80,0.2); border-color: #4caf50; color: #81c784; }
  .filter-btn[data-filter="tafline"].active { background: rgba(244,67,54,0.2); border-color: #f44336; color: #ef9a9a; }
  .filter-btn[data-filter="asher"].active { background: rgba(255,193,7,0.2); border-color: #ffc107; color: #ffd54f; }
  .filter-btn[data-filter="verity"].active { background: rgba(233,30,99,0.2); border-color: #e91e63; color: #f48fb1; }
  .filter-btn[data-filter="family"].active { background: rgba(0,188,212,0.2); border-color: #00bcd4; color: #80deea; }

  /* TIMELINE */
  .timeline-section { padding: 28px 32px; max-width: 1100px; margin: 0 auto; }
  .section-header {
    display: flex; align-items: center; gap: 10px;
    font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px;
    color: #546e7a; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #1e2433;
  }
  .section-header span { flex: 1; }
  .section-count { background: #1e2433; color: #546e7a; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }

  /* CARDS */
  .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(310px, 1fr)); gap: 16px; }

  .plan-card {
    background: #1a1f2e; border: 1px solid #2e3a50; border-radius: 14px;
    overflow: hidden; text-decoration: none; color: inherit;
    transition: transform 0.15s, border-color 0.2s, box-shadow 0.2s;
    display: flex; flex-direction: column; position: relative;
  }
  .plan-card[data-href] { cursor: pointer; }
  .plan-card[data-href]:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  .plan-card.hidden { display: none !important; }
  .plan-card { animation: fadeUp 0.25s ease both; }
  @keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

  .card-accent { height: 4px; width: 100%; }
  .card-inner { padding: 18px 20px; flex: 1; display: flex; flex-direction: column; }

  .card-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; margin-bottom: 10px; }
  .card-emoji { font-size: 2rem; line-height: 1; }
  .card-status {
    font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px;
    padding: 3px 9px; border-radius: 10px; white-space: nowrap;
  }
  .status-planning { background: rgba(255,193,7,0.15); color: #ffd54f; border: 1px solid rgba(255,193,7,0.3); }
  .status-confirmed { background: rgba(76,175,80,0.15); color: #81c784; border: 1px solid rgba(76,175,80,0.3); }
  .status-completed { background: rgba(255,255,255,0.07); color: #546e7a; border: 1px solid #2e3a50; }

  .card-category { font-size: 0.68rem; color: #546e7a; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .card-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 6px; line-height: 1.3; }
  .card-date { font-size: 0.8rem; color: #ce93d8; font-weight: 600; margin-bottom: 8px; }
  .card-desc { font-size: 0.78rem; color: #7a8a9a; line-height: 1.6; flex: 1; }

  .card-footer {
    padding: 10px 20px; border-top: 1px solid #1e2433;
    display: flex; justify-content: space-between; align-items: center;
  }
  .who-tags { display: flex; gap: 5px; flex-wrap: wrap; }
  .who-tag {
    font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border-radius: 10px;
  }
  .who-sage    { background: rgba(76,175,80,0.15);  color: #81c784; }
  .who-tafline { background: rgba(244,67,54,0.15);  color: #ef9a9a; }
  .who-asher   { background: rgba(255,193,7,0.15);  color: #ffd54f; }
  .who-verity  { background: rgba(233,30,99,0.15);  color: #f48fb1; }
  .who-family  { background: rgba(0,188,212,0.15);  color: #80deea; }

  .card-link { font-size: 0.75rem; color: #546e7a; }
  .plan-card[data-href]:hover .card-link { color: #ce93d8; }

  /* ARCHIVE ACCORDION */
  .archive-toggle {
    display: flex; align-items: center; gap: 10px; cursor: pointer;
    padding: 12px 0; user-select: none;
  }
  .archive-toggle:hover .section-header { color: #7a8a9a; }
  .archive-chevron { transition: transform 0.25s; font-size: 0.8rem; color: #546e7a; }
  .archive-chevron.open { transform: rotate(90deg); }
  .archive-cards { display: none; }
  .archive-cards.open { display: grid; grid-template-columns: repeat(auto-fill, minmax(310px, 1fr)); gap: 16px; }

  /* Completed cards are slightly dimmed */
  .plan-card.completed { opacity: 0.65; }
  .plan-card.completed:hover { opacity: 1; }

  /* PRINT */
  .print-btn {
    background: rgba(255,255,255,0.05); border: 1px solid #2e3a50; color: #7a8a9a;
    padding: 5px 13px; border-radius: 8px; font-size: 0.73rem; cursor: pointer;
    transition: all 0.15s;
  }
  .print-btn:hover { border-color: #546e7a; color: #e8eaf0; }

  footer {
    text-align: center; padding: 28px; font-size: 0.72rem; color: #3a4a5a;
    border-top: 1px solid #1e2433; margin-top: 20px;
  }

  @media (max-width: 600px) {
    .timeline-section { padding: 20px 16px; }
    .filter-bar { padding: 10px 16px; }
    header { padding: 20px 16px; }
  }

  
  /* ‚îÄ‚îÄ YEAR RIBBON ‚îÄ‚îÄ */
  .year-ribbon {
    background: #13151f; border-bottom: 1px solid #1e2433;
    padding: 8px 32px 6px; position: relative; overflow: visible;
  }
  .ribbon-track { position: relative; height: 48px; overflow: visible; }
  .ribbon-bars  { position: absolute; top: 0; left: 0; right: 0; height: 24px; }
  .ribbon-months { position: absolute; bottom: 0; left: 0; right: 0; height: 18px; }
  .ribbon-bar {
    position: absolute; height: 20px; top: 2px;
    border-radius: 4px; padding: 0 5px;
    display: flex; align-items: center;
    font-size: 0.6rem; font-weight: 700; color: rgba(255,255,255,0.92);
    overflow: hidden; white-space: nowrap; cursor: pointer;
    transition: filter 0.15s, transform 0.12s;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
  }
  .ribbon-bar:hover { filter: brightness(1.2); transform: scaleY(1.15); z-index: 5; }
  .ribbon-bar.past { opacity: 0.35; }
  .ribbon-month {
    display: flex; align-items: center; justify-content: center;
    font-size: 0.58rem; font-weight: 600; color: #2e3a50;
    border-left: 1px solid #1e2433; flex-shrink: 0; overflow: hidden;
  }
  .ribbon-month:first-child { border-left: none; }
  .ribbon-month.is-current { color: #546e7a; font-weight: 800; }
  .ribbon-today {
    position: absolute; top: 0; bottom: 0; width: 1px;
    background: rgba(255, 80, 80, 0.55); z-index: 10; pointer-events: none;
  }
  .ribbon-today::before {
    content: "\25BC"; position: absolute; top: -1px; left: -4px;
    font-size: 7px; color: rgba(255, 80, 80, 0.7); line-height: 1;
  }
  .ribbon-tip {
    position: absolute; background: #1a1f2e; border: 1px solid #2e3a50;
    border-radius: 8px; padding: 7px 12px; font-size: 0.72rem; color: #e8eaf0;
    pointer-events: none; z-index: 999; display: none; white-space: nowrap;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  }
  .ribbon-tip strong { color: #ce93d8; }
  /* Ribbon scroll bar */
  .ribbon-scrollbar {
    height: 6px; margin: 4px 0 0; border-radius: 3px;
    background: #1e2433; position: relative; cursor: pointer; flex-shrink: 0;
  }
  .ribbon-thumb {
    position: absolute; top: 0; height: 100%; border-radius: 3px;
    background: #3a4a5a; transition: background 0.1s; cursor: grab;
    min-width: 16px;
  }
  .ribbon-thumb:hover, .ribbon-thumb.dragging { background: #546e7a; cursor: grabbing; }

  @media (max-width: 600px) {
    .year-ribbon { padding: 6px 16px 4px; }
    .ribbon-bar { height: 26px; top: 1px; font-size: 0.62rem; }
    .ribbon-track { height: 52px; }
    .ribbon-bars { height: 30px; }
    .ribbon-months { height: 18px; }
  }
  @media print { .year-ribbon { display: none; } }

  @media print {
    .filter-bar, .print-btn, .archive-toggle .archive-chevron { display: none; }
    .archive-cards { display: grid !important; }
    .plan-card.completed { opacity: 1; }
    body { background: white; color: black; }
    .plan-card { border: 1px solid #ccc; break-inside: avoid; }
  }
</style>
</head>
<body>

<header>
  <div class="header-top">
    <div>
      <h1>üó∫Ô∏è Arbor Family Plans</h1>
      <p>Trips, adventures, and things worth planning</p>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <button class="print-btn" onclick="location.href='./scrapbook.html'">üìñ Scrapbook Builder</button>
      <div class="sophie-tag">üé≠ Maintained by Sophie</div>
    </div>
  </div>
</header>

<div id="sophie-notes" style="background:rgba(156,39,176,0.07);border-bottom:1px solid rgba(156,39,176,0.15);padding:9px 32px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
  <span style="font-size:0.72rem;color:#ce93d8;font-weight:700;">üé≠ Sophie:</span>
  <div style="display:flex;gap:16px;flex-wrap:wrap;" id="sophie-notes-items">
    <span style="font-size:0.73rem;color:#9c7ab0;">üèïÔ∏è Linville Gorge trail status ‚Äî <strong style="color:#ffd54f;">call (828) 652-2144</strong> before booking. West rim still closed from Helene.</span>
    <span style="font-size:0.73rem;color:#9c7ab0;">‚úàÔ∏è Japan fare alert active ‚Äî targeting &lt;$900/person. Check üìà Prices tab for trend.</span>
    <span style="font-size:0.73rem;color:#9c7ab0;">üèõÔ∏è Asher's DC trip Mar 4‚Äì6 added to calendar. Carpool 5:45 AM Wed.</span>
  </div>
  <button onclick="document.getElementById('sophie-notes').style.display='none'" style="margin-left:auto;background:none;border:none;color:#546e7a;cursor:pointer;font-size:1rem;line-height:1;">‚úï</button>
</div>

<div class="filter-bar">
  <span class="filter-label">Show:</span>
  <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
  <button class="filter-btn" data-filter="family" onclick="setFilter('family')">ü©µ Family</button>
  <button class="filter-btn" data-filter="sage" onclick="setFilter('sage')">üü¢ Sage</button>
  <button class="filter-btn" data-filter="tafline" onclick="setFilter('tafline')">üî¥ Tafline</button>
  <button class="filter-btn" data-filter="asher" onclick="setFilter('asher')">üü° Asher</button>
  <button class="filter-btn" data-filter="verity" onclick="setFilter('verity')">ü©∑ Verity</button>
</div>


<div class="year-ribbon" id="year-ribbon">
  <div class="ribbon-track" id="ribbon-track">
    <div class="ribbon-bars" id="ribbon-bars"></div>
    <div class="ribbon-months" id="ribbon-months"></div>
    <div class="ribbon-today" id="ribbon-today"></div>
    <div class="ribbon-tip" id="ribbon-tip"></div>
  </div>
  <div class="ribbon-scrollbar" id="ribbon-scrollbar"><div class="ribbon-thumb" id="ribbon-thumb"></div></div>
</div>

<div class="timeline-section">

  <!-- UPCOMING -->
  <div class="section-header">
    <span>üìÖ Upcoming</span>
    <span class="section-count" id="upcoming-count"></span>
  </div>
  <div class="cards" id="upcoming-cards"></div>

  <!-- ARCHIVE ACCORDION -->

  <div style="margin-top: 36px;">
    <div class="archive-toggle" onclick="toggleArchive()">
      <div class="section-header" style="flex:1;margin-bottom:0;border-bottom:none;padding-bottom:0;">
        <span>üì¶ Past Adventures</span>
        <span class="section-count" id="archive-count">0</span>
      </div>
      <span class="archive-chevron" id="archive-chevron">‚ñ∂</span>
    </div>
    <div class="archive-cards" id="archive-cards" style="margin-top:16px;"></div>
  </div>

</div>

<footer>
  Updated by Sophie üé≠ ¬∑ <a href="https://github.com/sophiearborbot/arbor-plans" style="color:#3a5a7a;">github.com/sophiearborbot/arbor-plans</a>
</footer>

<script>

// ‚îÄ‚îÄ‚îÄ LOAD & RENDER CARDS FROM MANIFEST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function() {
  try {
    var res = await fetch('./trips-manifest.json?t=' + Date.now());
    var manifest = await res.json();
    renderCards(manifest.trips || []);
  } catch(e) { console.warn('Cards: failed to load manifest', e); }
})();

function renderCards(trips) {
  var now = new Date(); now.setHours(0,0,0,0);

  // Sort by startDate
  trips.sort(function(a, b) {
    return new Date(a.startDate) - new Date(b.startDate);
  });

  var upcoming = trips.filter(function(t) {
    return !t.endDate || new Date(t.endDate + 'T00:00:00') >= now;
  });
  var past = trips.filter(function(t) {
    return t.endDate && new Date(t.endDate + 'T00:00:00') < now;
  });

  var upEl  = document.getElementById('upcoming-cards');
  var arcEl = document.getElementById('archive-cards');

  if (upcoming.length) {
    upcoming.forEach(function(t, idx) { upEl.appendChild(buildCard(t, idx === 0)); });
  } else {
    upEl.innerHTML = '<div style="grid-column:1/-1;padding:24px;text-align:center;color:#3a4a5a;font-size:0.82rem;">No upcoming trips planned yet.</div>';
  }

  if (past.length) {
    past.forEach(function(t) { arcEl.appendChild(buildCard(t, false, true)); });
  } else {
    arcEl.innerHTML = '<div style="grid-column:1/-1;padding:24px;text-align:center;color:#3a4a5a;font-size:0.82rem;background:#13151f;border-radius:10px;border:1px dashed #2e3a50;">Nothing here yet ‚Äî completed trips will be archived for the scrapbook \uD83D\uDCF8</div>';
  }

  updateCounts();
  document.getElementById('archive-count').textContent = past.length;
}

function buildCard(t, isNext, isArchived) {
  var WHO_CLASS = { sage:'who-sage', tafline:'who-tafline', asher:'who-asher', verity:'who-verity', family:'who-family' };
  var STATUS_CLASS = { planning:'status-planning', confirmed:'status-confirmed', completed:'status-completed' };

  var whoTags  = (t.whoTags || t.who || []);
  var dataWho  = whoTags.map(function(w){ return w.toLowerCase(); }).join(' ');
  var whoHtml  = whoTags.map(function(w) {
    var cls = WHO_CLASS[w.toLowerCase()] || '';
    return '<span class="who-tag ' + cls + '">' + w + '</span>';
  }).join('');

  // Status badges
  var extraBadges = (t.extraStatus || []).map(function(s) {
    return '<div class="card-status status-planning">' + s + '</div>';
  }).join('');
  var mainBadge = '<div class="card-status ' + (STATUS_CLASS[t.status] || 'status-planning') + '">' +
    (t.statusLabel || t.status) + '</div>';
  var badgeHtml = extraBadges
    ? '<div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;">' + extraBadges + '</div>'
    : mainBadge;

  var accentBg = 'linear-gradient(90deg, ' + (t.color || '#9c27b0') + ', ' + (t.accentColor2 || t.color || '#673ab7') + ')';
  var href = t.planPage || '#';

  var div = document.createElement('div');
  div.className = 'plan-card' + (isArchived ? ' completed' : '');
  div.dataset.href = href;
  div.dataset.who  = dataWho;
  if (isArchived) div.dataset.who += ' archived';
  div.setAttribute('onclick', 'location.href="' + href + '"');

  div.innerHTML =
    '<div class="card-accent" style="background:' + accentBg + '"></div>' +
    '<div class="card-inner">' +
      '<div class="card-top">' +
        '<div class="card-emoji">' + t.emoji + '</div>' +
        badgeHtml +
      '</div>' +
      '<div class="card-category">' + (t.category || '') + '</div>' +
      '<div class="card-title">'   + t.title + '</div>' +
      '<div class="card-date">\uD83D\uDCC5 ' + (t.dateLabel || t.dates) + '</div>' +
      '<div class="card-desc">'   + (t.desc || '') + '</div>' +
    '</div>' +
    '<div class="card-footer">' +
      '<div class="who-tags">' + whoHtml + '</div>' +
      '<span class="card-link">' + (t.cardLink || 'View ‚Üí') + '</span>' +
    '</div>';

  if (isNext) {
    var pin = document.createElement('div');
    pin.style.cssText = 'position:absolute;top:12px;right:12px;background:rgba(255,255,255,0.08);color:#ce93d8;font-size:0.65rem;font-weight:700;padding:2px 8px;border-radius:8px;letter-spacing:0.5px;';
    pin.textContent = 'NEXT UP';
    div.appendChild(pin);
    div.style.borderColor = '#4a5a7a';
  }

  return div;
}

// Filter logic
function setFilter(f) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`[data-filter="${f}"]`).classList.add('active');

  document.querySelectorAll('.plan-card').forEach(card => {
    const who = card.dataset.who || '';
    card.classList.toggle('hidden', f !== 'all' && !who.includes(f));
  });
  updateCounts();
}

function updateCounts() {
  const upcoming = document.querySelectorAll('#upcoming-cards .plan-card:not(.hidden)').length;
  document.getElementById('upcoming-count').textContent = upcoming;
}

// Archive accordion
function toggleArchive() {
  const cards = document.getElementById('archive-cards');
  const chevron = document.getElementById('archive-chevron');
  const open = cards.classList.toggle('open');
  chevron.classList.toggle('open', open);
  chevron.textContent = open ? '‚ñº' : '‚ñ∂';
}

// Countdown timers
const countdowns = {
  'Apr 9‚Äì12, 2026':   new Date('2026-04-09'),
  'May 9‚Äì16, 2026':   new Date('2026-05-09'),
  'Jun 12‚Äì28, 2026':  new Date('2026-06-12'),
};

document.querySelectorAll('.card-date').forEach(el => {
  const text = el.textContent;
  for (const [label, date] of Object.entries(countdowns)) {
    if (text.includes(label.replace('üìÖ ',''))) {
      const days = Math.ceil((date - new Date()) / 86400000);
      if (days > 0) {
        const chip = document.createElement('span');
        chip.style.cssText = 'margin-left:8px;font-size:0.65rem;background:rgba(255,255,255,0.07);color:#7a8a9a;padding:2px 7px;border-radius:8px;font-weight:600;';
        chip.textContent = `${days}d away`;
        if (days < 30) { chip.style.background = 'rgba(255,193,7,0.15)'; chip.style.color = '#ffd54f'; }
        if (days < 14) { chip.style.background = 'rgba(76,175,80,0.15)';  chip.style.color = '#81c784'; }
        el.appendChild(chip);
      }
    }
  }
});

// Highlight next upcoming card
const cards = [...document.querySelectorAll('#upcoming-cards .plan-card')];
if (cards.length) {
  cards[0].style.borderColor = '#4a5a7a';
  const pin = document.createElement('div');
  pin.style.cssText = 'position:absolute;top:12px;right:12px;background:rgba(255,255,255,0.08);color:#ce93d8;font-size:0.65rem;font-weight:700;padding:2px 8px;border-radius:8px;letter-spacing:0.5px;';
  pin.textContent = 'NEXT UP';
  cards[0].appendChild(pin);
}


// ‚îÄ‚îÄ‚îÄ YEAR RIBBON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function() {
  try {
    var res = await fetch('./trips-manifest.json?t=' + Date.now());
    var manifest = await res.json();
    renderRibbon(manifest.trips || []);
  } catch(e) { console.warn('Ribbon: failed to load manifest', e); }
})();

function renderRibbon(trips) {
  var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var MSHORT = ['J','F','M','A','M','J','J','A','S','O','N','D'];

  var today = new Date(); today.setHours(0,0,0,0);
  var fullStart = new Date(today.getFullYear(), today.getMonth(), 1);
  var fullEnd   = new Date(fullStart.getFullYear() + 1, fullStart.getMonth(), fullStart.getDate());
  var fullMs    = fullEnd - fullStart;
  var minMs     = 28 * 86400000;

  var viewStart = new Date(fullStart);
  var viewEnd   = new Date(fullEnd);

  var barsEl   = document.getElementById('ribbon-bars');
  var monthsEl = document.getElementById('ribbon-months');
  var todayEl  = document.getElementById('ribbon-today');
  var track    = document.getElementById('ribbon-track');
  var tip      = document.getElementById('ribbon-tip');
  var scrollbar = document.getElementById('ribbon-scrollbar');
  var thumb     = document.getElementById('ribbon-thumb');

  // Build trip data
  var tripData = [];
  trips.forEach(function(t) {
    if (!t.startDate || !t.endDate) return;
    var s = new Date(t.startDate + 'T00:00:00');
    var e = new Date(t.endDate   + 'T00:00:00');
    if (e < fullStart || s > fullEnd) return;
    tripData.push({
      trip: t, start: s, end: e,
      isPast:   e < today,
      daysAway: Math.ceil((s - today) / 86400000),
      tripDays: Math.round((e - s) / 86400000)
    });
  });

  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function viewPct(date) {
    var viewMs = viewEnd - viewStart;
    return (date - viewStart) / viewMs * 100;
  }

  function bestLabel(bar, td, wPx) {
    // Try labels from longest to shortest; pick first that fits
    var title     = td.trip.emoji + ' ' + td.trip.title;
    var firstWord = td.trip.emoji + ' ' + td.trip.title.split(/[\s\u2014\u2013]/)[0];
    var emojiOnly = td.trip.emoji;

    // Estimate text width using canvas
    var ctx = bestLabel._ctx;
    if (!ctx) {
      var c = document.createElement('canvas');
      ctx = bestLabel._ctx = c.getContext('2d');
      ctx.font = '600 9px Inter, sans-serif';
    }

    if (wPx >= ctx.measureText(title).width + 12)     return title;
    if (wPx >= ctx.measureText(firstWord).width + 12)  return firstWord;
    if (wPx >= ctx.measureText(emojiOnly).width + 8)   return emojiOnly;
    return '';
  }

  function render() {
    var viewMs   = viewEnd - viewStart;
    var trackW   = track.offsetWidth;

    barsEl.innerHTML   = '';
    monthsEl.innerHTML = '';

    // Today
    var tp = viewPct(today);
    todayEl.style.left    = tp + '%';
    todayEl.style.display = (tp >= 0 && tp <= 100) ? '' : 'none';

    // Months
    var mo = new Date(viewStart.getFullYear(), viewStart.getMonth(), 1);
    while (mo < viewEnd) {
      var moEnd = new Date(mo.getFullYear(), mo.getMonth() + 1, 1);
      var l = Math.max(0,   viewPct(mo));
      var r = Math.min(100, viewPct(moEnd));
      if (r > l) {
        var wPx = (r - l) / 100 * trackW;
        var div = document.createElement('div');
        var isCur = mo.getMonth() === today.getMonth() && mo.getFullYear() === today.getFullYear();
        div.className = 'ribbon-month' + (isCur ? ' is-current' : '');
        div.style.cssText = 'position:absolute;left:' + l + '%;width:' + (r-l) + '%;bottom:0;height:100%;' +
          'display:flex;align-items:center;justify-content:center;overflow:hidden;' +
          'font-size:0.58rem;border-left:1px solid #1e2433;box-sizing:border-box;';
        div.style.fontWeight = isCur ? '800' : '600';
        div.style.color = isCur ? '#546e7a' : '#2e3a50';
        div.textContent = wPx > 38 ? MONTHS[mo.getMonth()] : wPx > 16 ? MSHORT[mo.getMonth()] : '';
        monthsEl.appendChild(div);
      }
      mo = moEnd;
    }

    // Bars
    tripData.forEach(function(td) {
      var l = viewPct(td.start);
      var r = viewPct(td.end);
      if (r < 0 || l > 100) return;
      l = Math.max(0, l);
      r = Math.min(100, r);
      var w   = Math.max(r - l, 0.8);
      var wPx = w / 100 * trackW;

      var bar = document.createElement('div');
      bar.className = 'ribbon-bar' + (td.isPast ? ' past' : '');
      bar.style.left       = l + '%';
      bar.style.width      = w + '%';
      bar.style.background = td.trip.color || '#9c27b0';
      bar.dataset.tripId   = td.trip.id;
      bar.textContent      = bestLabel(bar, td, wPx);
      barsEl.appendChild(bar);
    });

    // Scrollbar thumb
    var thumbLeft  = (viewStart - fullStart) / fullMs * 100;
    var thumbWidth = viewMs / fullMs * 100;
    thumb.style.left  = thumbLeft  + '%';
    thumb.style.width = thumbWidth + '%';
  }

  // ‚îÄ‚îÄ CLAMP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function clampView() {
    var viewMs = Math.max(minMs, Math.min(fullMs, viewEnd - viewStart));
    if (viewStart < fullStart) { viewStart = new Date(fullStart); viewEnd = new Date(viewStart.getTime() + viewMs); }
    if (viewEnd   > fullEnd)   { viewEnd   = new Date(fullEnd);   viewStart = new Date(viewEnd.getTime() - viewMs); }
    if (viewStart < fullStart) viewStart = new Date(fullStart);
  }

  // ‚îÄ‚îÄ SCRUB TIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var lastHitId = null;

  function tripAtClientX(clientX) {
    var rect = track.getBoundingClientRect();
    var p = (clientX - rect.left) / rect.width * 100;
    for (var i = 0; i < tripData.length; i++) {
      if (p >= viewPct(tripData[i].start) && p <= viewPct(tripData[i].end)) return tripData[i];
    }
    return null;
  }

  function showTip(clientX) {
    var rect   = track.getBoundingClientRect();
    var p      = Math.max(0, Math.min(100, (clientX - rect.left) / rect.width * 100));
    var viewMs = viewEnd - viewStart;
    var date   = new Date(viewStart.getTime() + (p / 100) * viewMs);
    var hit    = tripAtClientX(clientX);

    if (hit) {
      var label = hit.daysAway > 0 ? ('in ' + hit.daysAway + 'd') : (hit.isPast ? 'past' : 'now');
      tip.innerHTML = '<strong>' + hit.trip.emoji + ' ' + hit.trip.title + '</strong><br>' +
        hit.trip.dates + ' &middot; ' + hit.tripDays + 'd &middot; <span style="color:#81c784">' + label + '</span>';
      if (lastHitId !== hit.trip.id) {
        barsEl.querySelectorAll('.ribbon-bar').forEach(function(b){ b.style.filter = ''; });
        var ab = barsEl.querySelector('[data-trip-id="' + hit.trip.id + '"]');
        if (ab) ab.style.filter = 'brightness(1.35)';
        lastHitId = hit.trip.id;
      }
    } else {
      tip.innerHTML = '<span style="color:#7a8a9a">' + MONTHS[date.getMonth()] + ' ' + date.getDate() + '</span>';
      if (lastHitId) { barsEl.querySelectorAll('.ribbon-bar').forEach(function(b){ b.style.filter=''; }); lastHitId = null; }
    }

    tip.style.display = 'block';
    var tipW = tip.offsetWidth;
    var trackW = rect.width;
    tip.style.left = Math.max(0, Math.min((p/100)*trackW - tipW/2, trackW - tipW)) + 'px';
    tip.style.top  = '-42px';
  }

  function hideTip() {
    tip.style.display = 'none';
    barsEl.querySelectorAll('.ribbon-bar').forEach(function(b){ b.style.filter = ''; });
    lastHitId = null;
  }

  // ‚îÄ‚îÄ TOUCH: 1 finger = scrub, 2 finger = pinch zoom ‚îÄ‚îÄ
  var touchState = null;

  function touchDist(t1, t2) {
    var dx = t1.clientX - t2.clientX, dy = t1.clientY - t2.clientY;
    return Math.sqrt(dx*dx + dy*dy);
  }

  track.addEventListener('touchstart', function(e) {
    if (e.touches.length === 1) {
      touchState = { mode: 'scrub' };
      showTip(e.touches[0].clientX);
    } else if (e.touches.length === 2) {
      touchState = {
        mode: 'pinch',
        initDist: touchDist(e.touches[0], e.touches[1]),
        initMidX: (e.touches[0].clientX + e.touches[1].clientX) / 2,
        initViewStart: new Date(viewStart),
        initViewEnd:   new Date(viewEnd)
      };
      hideTip();
    }
    e.preventDefault();
  }, { passive: false });

  track.addEventListener('touchmove', function(e) {
    if (!touchState) return;
    if (touchState.mode === 'scrub' && e.touches.length === 1) {
      showTip(e.touches[0].clientX);
    } else if (e.touches.length === 2) {
      if (touchState.mode !== 'pinch') {
        touchState = { mode: 'pinch',
          initDist: touchDist(e.touches[0], e.touches[1]),
          initMidX: (e.touches[0].clientX + e.touches[1].clientX) / 2,
          initViewStart: new Date(viewStart), initViewEnd: new Date(viewEnd) };
      }
      var curDist  = touchDist(e.touches[0], e.touches[1]);
      var scale    = touchState.initDist / curDist;
      var initMs   = touchState.initViewEnd - touchState.initViewStart;
      var newMs    = Math.max(minMs, Math.min(fullMs, initMs * scale));
      var rect     = track.getBoundingClientRect();
      var midPct   = (touchState.initMidX - rect.left) / rect.width;
      var anchor   = touchState.initViewStart.getTime() + midPct * initMs;
      viewStart    = new Date(anchor - midPct * newMs);
      viewEnd      = new Date(viewStart.getTime() + newMs);
      clampView(); render();
    }
    e.preventDefault();
  }, { passive: false });

  track.addEventListener('touchend', function(e) {
    if (touchState && touchState.mode === 'scrub') {
      var hit = tripAtClientX(e.changedTouches[0].clientX);
      if (hit) setTimeout(function(){ navigateToTrip(hit.trip); }, 150);
      else     setTimeout(hideTip, 700);
    }
    if (e.touches.length === 0) touchState = null;
  });

  // ‚îÄ‚îÄ MOUSE on track ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  track.addEventListener('mousemove',  function(e){ showTip(e.clientX); });
  track.addEventListener('mouseleave', hideTip);
  track.addEventListener('click',      function(e){
    var hit = tripAtClientX(e.clientX);
    if (hit) navigateToTrip(hit.trip);
  });
  track.addEventListener('wheel', function(e) {
    e.preventDefault();
    var rect   = track.getBoundingClientRect();
    var viewMs = viewEnd - viewStart;
    if (e.ctrlKey || e.metaKey) {
      var factor = 1 + e.deltaY * 0.008;
      factor = Math.max(0.5, Math.min(2, factor));
      var midPct = (e.clientX - rect.left) / rect.width;
      var anchor = viewStart.getTime() + midPct * viewMs;
      var newMs  = Math.max(minMs, Math.min(fullMs, viewMs * factor));
      viewStart  = new Date(anchor - midPct * newMs);
      viewEnd    = new Date(viewStart.getTime() + newMs);
    } else {
      var panMs = (e.deltaX || e.deltaY) * viewMs / rect.width * 0.5;
      viewStart = new Date(viewStart.getTime() + panMs);
      viewEnd   = new Date(viewEnd.getTime()   + panMs);
    }
    clampView(); render();
  }, { passive: false });

  // ‚îÄ‚îÄ SCROLLBAR THUMB drag (mouse + touch) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var sbDrag = null;

  function sbStart(clientX) {
    sbDrag = { startX: clientX, startViewStart: new Date(viewStart), startViewEnd: new Date(viewEnd) };
    thumb.classList.add('dragging');
  }
  function sbMove(clientX) {
    if (!sbDrag) return;
    var sbW   = scrollbar.offsetWidth;
    var dx    = clientX - sbDrag.startX;
    var panMs = dx / sbW * fullMs;
    viewStart = new Date(sbDrag.startViewStart.getTime() + panMs);
    viewEnd   = new Date(sbDrag.startViewEnd.getTime()   + panMs);
    clampView(); render();
  }
  function sbEnd() {
    sbDrag = null;
    thumb.classList.remove('dragging');
  }

  thumb.addEventListener('mousedown',  function(e){ sbStart(e.clientX); e.preventDefault(); });
  document.addEventListener('mousemove', function(e){ sbMove(e.clientX); });
  document.addEventListener('mouseup',   sbEnd);

  thumb.addEventListener('touchstart', function(e){ sbStart(e.touches[0].clientX); e.preventDefault(); }, { passive: false });
  thumb.addEventListener('touchmove',  function(e){ sbMove(e.touches[0].clientX); e.preventDefault(); }, { passive: false });
  thumb.addEventListener('touchend',   sbEnd);

  // Click on scrollbar bg to jump
  scrollbar.addEventListener('click', function(e) {
    if (e.target === thumb) return;
    var rect     = scrollbar.getBoundingClientRect();
    var viewMs   = viewEnd - viewStart;
    var clickPct = (e.clientX - rect.left) / rect.width;
    var center   = fullStart.getTime() + clickPct * fullMs;
    viewStart    = new Date(center - viewMs / 2);
    viewEnd      = new Date(center + viewMs / 2);
    clampView(); render();
  });

  render();
}

function navigateToTrip(trip) {
  var sel  = '.plan-card[data-href*="' + trip.id + '"]';
  var sel2 = '.plan-card[data-href="' + (trip.planPage || '') + '"]';
  var card = document.querySelector(sel) || document.querySelector(sel2);
  if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  else if (trip.planPage) location.href = trip.planPage;
}

</script>
</body>
</html>
